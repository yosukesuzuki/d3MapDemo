{% extends "mainapp/base.html"%}
{% block title %}{{ title }}{% endblock %}
{% block description %}{% endblock %}
{% block content %}
<h1>{{title}}</h1>
<div id="main">
    <div>
        <h3>{{_('Select image files from local computer')}}</h3>
        <input id="imageuploadform" type="file" multiple="multiple" />
    </div>
    <div>
        <h3>{{_('Or drop image files')}}</h3>
        <div id="imagetarget" draggable="true" style="width:320px;border:3px dotted;text-align:center;padding:60px 0;">
            <span>{{_('Drop here')}}</span>
        </div>
    </div>

    <div>
        <h3>{{_('Image List')}}</h3>
        <table class="table" id="images">
        </table>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
//thanks to http://shiba-yan.hatenablog.jp/entry/20110702/1309532938
    var uploadFiles = function (files) {
        var fd = new FormData();
        for (var i = 0; i < files.length; i++) {
            fd.append("files", files[i]);
        }
        $.getJSON('/admin/image/upload/url/', function (result) {
            var upload_url = result;
            $('#imagetarget').html('<p>{{_('uploading...')}}</p><img src="/media/img/ajax-loader.gif">');
            $.ajax({
                url: upload_url,
                type: "POST",
                data: fd,
                processData: false,
                contentType: false,
                success:function(uploadresult){
                    $('#imagetarget').html('<span>{{_('Drop here')}}</span>');
                    setTimeout( function() {showImageList();}, 1000);
                }
            });
        });
    };

    $("#imageuploadform").on("change", function () {
        var files = this.files;
        uploadFiles(files);
    });

    $("#imagetarget").on("dragover", function () {
        return false;
    })
    .on("dragenter", function () {
        return false;
    })
    .on("drop", function (e) {
        var files = e.originalEvent.dataTransfer.files;
        uploadFiles(files);
        e.preventDefault();
        return false;
    });
    function showImageList(){
        $('#images').html('');
        $.getJSON('/admin/image/list/json/', function (result) {
            var uploaded_images = result.images;
            for(var i =0; i < uploaded_images.length; i++){
                var temp_html = '<tr>';
                var temp_title,temp_note;
                temp_html += '<td class="span2"><img src="'+uploaded_images[i].image_path+'=s100"></td>';
                if(uploaded_images[i].title == ''){temp_title = '[{{_('Edit Title')}}]';}else{temp_title = uploaded_images[i].title;}
                temp_html += '<td class="span8"><h4 contenteditable=true>'+temp_title+'</h4>';
                if(uploaded_images[i].note == ''){temp_note = '[{{_('Edit Note')}}]';}else{temp_note = uploaded_images[i].note;}
                temp_html += '<p contenteditable=true>'+temp_note+'</p>';
                temp_html += '<h5>{{_('File Name')}}:'+uploaded_images[i].file_name+'</h5>';
                temp_html += '</td>';
                temp_html += '<td class="span2"><button class="btn btn-danger">{{_('Delete')}}</button></td>';
                temp_html += '</tr>';
                $('#images').append(temp_html);
            }
        });
    }
    $(document).ready(function(){
        showImageList();
    });
</script>
{% endblock %}
